import{j as e}from"./ui-vendor-DF-Sc9oH.js";import{f as q,u as Q,r as m}from"./wallet-adapter-2kvs9I98.js";import{h as V,T as S}from"./solana-vendor-BSgPtt5G.js";import{u as _,C as ee,a as te}from"./copy-yUNuGRaa.js";import{t as u}from"./index-BCtTQOvw.js";import{P as re,a as ne,R as se,T as ae,i as oe,f as ce,b as ie}from"./intervalToDuration-B0kjsJsx.js";import"vite-plugin-node-polyfills/shims/buffer";function fe(){const{connection:h}=q(),i=Q(),l=_(i,h),[R,v]=m.useState(!0),[j,f]=m.useState(!1),[g,L]=m.useState([]),[s,P]=m.useState(null),[N,W]=m.useState(new Map),[k,C]=m.useState(new Set),[T,D]=m.useState(new Set),[A,K]=m.useState(new Set),[$,M]=m.useState(null);m.useEffect(()=>{i.publicKey?.toString()&&f(!1)},[i.publicKey]),m.useEffect(()=>{(async()=>{if(!(!l||j)){if(!i.publicKey)return u.error("Wallet not connected");try{v(!0);const n=await l.getAllPaymentPolicies(),a=new Map,t=new Map;for(const o of n){const p=o.account.userPayment.toString();if(!a.has(p)){const d=await l.getUserPayment(o.account.userPayment);if(d){if(d.owner.toString()!=i.publicKey.toString())continue;a.set(p,{userPaymentAddress:o.account.userPayment,userPayment:d,policies:[]});const b=d.tokenMint.toString();if(!t.has(b))try{const w=await V(h,d.tokenMint);t.set(b,{decimals:w.decimals,symbol:"TOKEN"})}catch(w){console.error("Error fetching mint info:",w)}}}const x=a.get(p);x&&x.policies.push(o)}if(t.set("4zMMC9srt5Ri5X14GAgXhaHii3GnPAEERYPJgZJDncDU",{decimals:6,symbol:"USDC"}),L(Array.from(a.values())),W(t),Array.from(a.values()).length>0){const o=Array.from(a.values())[0].policies[0];P(o)}f(!0)}catch(n){console.error("Error fetching payment policies:",n)}finally{v(!1)}}})()},[l,j,h,i.publicKey]);const G=r=>{const n=r.policyType;return n.subscription?Number(n.subscription.amount).toString():null},I=(r,n)=>{if(!r)return"N/A";const a=N.get(n.toString());if(!a)return r;const t=Number(r)/Math.pow(10,a.decimals);return a.symbol?`${t.toLocaleString()} ${a.symbol}`:t.toLocaleString()},F=r=>{const n=r.policyType;let a=0;if(n.subscription&&(a=Number(n.subscription.intervalSeconds)),a===0)return"N/A";const t=oe({start:0,end:a*1e3});return ce(t,{format:["days","hours","minutes"]})},X=r=>{if(!r.nextPaymentDue)return"N/A";const n=new Date(r.nextPaymentDue.toNumber()*1e3);return n<new Date?"Overdue":ie(n,{addSuffix:!0})},E=r=>{const n=r.status;return n.active?"Active":n.paused?"Paused":n.cancelled?"Cancelled":n.completed?"Completed":"Unknown"},J=r=>{const n=r.policyType;return n.subscription?"Subscription":n.oneTime?"One Time":n.installment?"Installment":"Unknown"},U=r=>{if(!r.memo||r.memo.length===0)return"";try{const n=new TextDecoder,a=r.memo.filter(t=>t!==0);return n.decode(new Uint8Array(a))}catch{return""}},Y=r=>r.nextPaymentDue?new Date(r.nextPaymentDue.toNumber()*1e3)<=new Date:!1,z=(r,n)=>{navigator.clipboard.writeText(r),M(n),setTimeout(()=>M(null),2e3)},B=async(r,n,a)=>{if(!l||!i.publicKey)return u.error("Wallet not connected");try{const t=await l.getPaymentGateway(n.gateway);if(!t)return u.error("Gateway not found");if(t.authority.toString()!==i.publicKey.toString()&&a.owner.toString()!=i.publicKey.toString())return u.error("Only the gateway authority can execute payments");C(d=>new Set(d).add(r.toString()));const o=new S;(await l.executePayment(r)).map(d=>o.add(d));const x=await l.provider.sendAndConfirm(o);u.success(`Payment executed! TX: ${x}`),f(!1)}catch(t){console.error("Error:",t),u.error(t instanceof Error?t.message:"Failed to execute payment")}finally{C(t=>{const o=new Set(t);return o.delete(r.toString()),o})}},H=async(r,n,a)=>{if(!l||!i.publicKey)return u.error("Wallet not connected");if(a.owner.toString()!==i.publicKey.toString())return u.error("Only the policy owner can change status");try{D(b=>new Set(b).add(r.toString()));const o=n.status.active,p=o?{paused:{}}:{active:{}},x=new S,d=await l.changePaymentPolicyStatus(a.tokenMint,n.policyId,p);x.add(d),await l.provider.sendAndConfirm(x),u.success(`Payment policy ${o?"paused":"resumed"}!`),f(!1)}catch(t){console.error("Error:",t),u.error(t instanceof Error?t.message:"Failed to toggle status")}finally{D(t=>{const o=new Set(t);return o.delete(r.toString()),o})}},Z=async(r,n,a)=>{if(!l||!i.publicKey)return u.error("Wallet not connected");if(a.owner.toString()!==i.publicKey.toString())return u.error("Only the policy owner can delete");if(confirm("Delete this payment policy? This cannot be undone."))try{K(p=>new Set(p).add(r.toString()));const t=new S,o=await l.deletePaymentPolicy(a.tokenMint,n.policyId);t.add(o),await l.provider.sendAndConfirm(t),u.success("Payment policy deleted!"),f(!1)}catch(t){console.error("Error:",t),u.error(t instanceof Error?t.message:"Failed to delete")}finally{K(t=>{const o=new Set(t);return o.delete(r.toString()),o})}};if(!i.connected)return e.jsx("div",{className:"flex items-center justify-center min-h-[500px]",children:e.jsx("p",{className:"text-lg text-gray-600",children:"Please connect your wallet to view your account"})});if(R)return e.jsxs("div",{className:"flex flex-col items-center justify-center min-h-[500px] gap-4",children:[e.jsx("div",{className:"w-16 h-16 border-4 border-[var(--color-primary)] border-t-transparent rounded-full animate-spin"}),e.jsx("p",{className:"text-sm uppercase tracking-wide",style:{fontFamily:"var(--font-secondary)",color:"var(--color-primary)"},children:"Loading..."})]});if(g.length<1)return e.jsx("div",{className:"flex items-center justify-center min-h-[500px]",children:e.jsx("p",{className:"text-lg text-gray-600",children:"You don't have any Subscriptions yet"})});const y=s?g.find(r=>r.policies.some(n=>n.publicKey.toString()===s.publicKey.toString())):null,c=({label:r,value:n,copyable:a})=>e.jsxs("div",{className:"flex items-center py-3 border-b border-gray-100 last:border-0",children:[e.jsx("span",{className:"min-w-[200px] text-sm text-gray-600 uppercase font-medium",children:r}),e.jsxs("div",{className:"flex items-center gap-3 flex-1",children:[e.jsx("span",{className:"text-sm break-all text-gray-900",children:n}),a&&e.jsx("button",{onClick:()=>z(n,r),className:"p-1.5 hover:bg-gray-100 rounded transition-colors flex-shrink-0",title:"Copy to clipboard",children:$===r?e.jsx(ee,{className:"h-4 w-4 text-green-600"}):e.jsx(te,{className:"h-4 w-4 text-gray-500"})})]})]});let O=0;return e.jsxs("div",{className:"flex items-start",children:[e.jsx("div",{className:"w-[368px] border-r border-gray-200",children:e.jsx("div",{className:"flex flex-col",children:g.map(({policies:r,userPayment:n})=>{const a=r.map(t=>{O++;const o=s?.publicKey.toString()===t.publicKey.toString();return e.jsxs("div",{onClick:()=>P(t),className:"h-14 flex items-center px-4 cursor-pointer transition-colors hover:bg-gray-50",style:{backgroundColor:o?"#f5f7f7":"transparent"},children:[e.jsx("div",{className:"w-8 h-8 flex items-center justify-center border border-[var(--color-primary)] rounded text-xs",style:{backgroundColor:o?"#fff":"transparent"},children:O}),e.jsxs("div",{className:"ml-3 flex items-center gap-2 text-sm",children:[e.jsxs("span",{className:"uppercase",style:{color:"var(--color-primary)"},children:["Policy-",t.account.policyId]}),e.jsxs("span",{className:"uppercase text-gray-600",children:["( ",t.account.paymentCount," )"]})]})]},t.publicKey.toString())});return e.jsxs("div",{children:[e.jsx("div",{className:"h-12 flex items-center justify-between px-4 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"uppercase text-sm",children:N.get(n.tokenMint.toString())?.symbol??"unknown"}),e.jsxs("span",{className:"uppercase text-sm",children:["(",g.reduce((t,o)=>t+o.policies.length,0),")"]})]})}),e.jsx("div",{children:a})]})})})}),e.jsxs("div",{className:"flex-1 overflow-y-auto",children:[e.jsx("div",{className:"h-12 flex items-center px-6 border-b border-gray-200",children:e.jsx("span",{className:"uppercase text-sm",children:s?`Policy-${s.account.policyId} subscription`:"Select a policy"})}),s&&y&&e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("svg",{className:"w-4 h-4",viewBox:"0 0 18 18",fill:"none",stroke:"var(--color-primary)",strokeWidth:"2",children:e.jsx("circle",{cx:"9",cy:"9",r:"7"})}),e.jsx("span",{className:"underline font-medium",children:"Details"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>B(s.publicKey,s.account,y.userPayment),disabled:!Y(s.account)||k.has(s.publicKey.toString()),className:"p-2 border border-blue-600 rounded hover:bg-blue-600 hover:text-white transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:k.has(s.publicKey.toString())?e.jsx("div",{className:"w-4 h-4 border-2 border-current border-t-transparent rounded-full animate-spin"}):e.jsx(re,{className:"h-4 w-4"})}),e.jsx("button",{onClick:()=>H(s.publicKey,s.account,y.userPayment),disabled:T.has(s.publicKey.toString()),className:"p-2 border border-orange-600 rounded hover:bg-orange-600 hover:text-white transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:T.has(s.publicKey.toString())?e.jsx("div",{className:"w-4 h-4 border-2 border-current border-t-transparent rounded-full animate-spin"}):E(s.account)==="Active"?e.jsx(ne,{className:"h-4 w-4"}):e.jsx(se,{className:"h-4 w-4"})}),e.jsx("button",{onClick:()=>Z(s.publicKey,s.account,y.userPayment),disabled:A.has(s.publicKey.toString()),className:"p-2 border border-red-600 rounded hover:bg-red-600 hover:text-white transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:A.has(s.publicKey.toString())?e.jsx("div",{className:"w-4 h-4 border-2 border-current border-t-transparent rounded-full animate-spin"}):e.jsx(ae,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"max-w-[700px]",children:[e.jsx(c,{label:"Policy Address",value:s.publicKey.toString(),copyable:!0}),e.jsx(c,{label:"Owner",value:y.userPayment.owner.toString(),copyable:!0}),e.jsx(c,{label:"Policy ID",value:`#${s.account.policyId}`}),e.jsx(c,{label:"Type",value:J(s.account)}),e.jsx(c,{label:"Status",value:E(s.account)}),e.jsx(c,{label:"Recipient",value:s.account.recipient.toString(),copyable:!0}),e.jsx(c,{label:"Gateway",value:s.account.gateway.toString(),copyable:!0}),e.jsx(c,{label:"Token Mint",value:y.userPayment.tokenMint.toString(),copyable:!0}),e.jsx(c,{label:"Amount",value:I(G(s.account),y.userPayment.tokenMint)}),e.jsx(c,{label:"Interval",value:F(s.account)}),e.jsx(c,{label:"Next Payment",value:X(s.account)}),e.jsx(c,{label:"Total Paid",value:I(s.account.totalPaid.toString(),y.userPayment.tokenMint)}),e.jsx(c,{label:"Payments",value:s.account.paymentCount.toString()}),e.jsx(c,{label:"Created",value:new Date(y.userPayment.createdAt.toNumber()*1e3).toLocaleString()}),U(s.account)&&e.jsx(c,{label:"Memo",value:U(s.account)})]})]})]})]})}export{fe as default};

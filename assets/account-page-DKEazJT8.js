import{j as e}from"./ui-vendor-DjqEzDKD.js";import{L as Q,J as V,r as m}from"./wallet-adapter-xIsJfVGg.js";import{f as _,T as j}from"./solana-vendor-D4f6MxZu.js";import{u as ee,C as te,a as ne}from"./copy-yLzcndq3.js";import{d as re}from"./utils-BcOd_yge.js";import{P as se,a as ae,b as oe,R as ce,T as ie,i as le,f as ue,c as de,t as d}from"./intervalToDuration-CiH4fVyb.js";import"./createLucideIcon-C6LKdIJQ.js";function he(){const{connection:w}=Q(),c=V(),i=ee(c,w),[$,P]=m.useState(!0),[N,f]=m.useState(!1),[g,R]=m.useState([]),[s,k]=m.useState(null),[T,L]=m.useState(new Map),[K,C]=m.useState(new Set),[D,A]=m.useState(new Set),[M,I]=m.useState(new Set),[G,E]=m.useState(null);m.useEffect(()=>{c.publicKey?.toString()&&f(!1)},[c.publicKey]),m.useEffect(()=>{(async()=>{if(!(!i||N)&&c.publicKey)try{P(!0);const n=await i.getAllUserPaymentsByOwner(c.publicKey),o=new Map,r=new Map;for(const a of n){const u=await i.getPaymentPoliciesByUser(a.publicKey);for(const p of u){const x=p.account.userPayment.toString();if(!o.has(x)){const b=await i.getUserPayment(p.account.userPayment);if(b){if(b.owner.toString()!=c.publicKey.toString())continue;o.set(x,{userPaymentAddress:p.account.userPayment,userPayment:b,policies:[]});const F=b.tokenMint.toString();if(!r.has(F))try{const v=await _(w,b.tokenMint);r.set(F,{decimals:v.decimals,symbol:"TOKEN"})}catch(v){console.error("Error fetching mint info:",v)}}}const h=o.get(x);h&&h.policies.push(p)}}if(r.set("4zMMC9srt5Ri5X14GAgXhaHii3GnPAEERYPJgZJDncDU",{decimals:6,symbol:"USDC"}),R(Array.from(o.values())),L(r),Array.from(o.values()).length>0){const a=Array.from(o.values())[0].policies[0];k(a)}f(!0)}catch(n){console.error("Error fetching payment policies:",n)}finally{P(!1)}})()},[i,N,w,c.publicKey]);const W=t=>{const n=t.policyType;return n.subscription?Number(n.subscription.amount).toString():null},U=(t,n)=>{if(!t)return"N/A";const o=T.get(n.toString());if(!o)return t;const a=(Number(t)/Math.pow(10,o.decimals)).toLocaleString(void 0,{minimumFractionDigits:0,maximumFractionDigits:o.decimals});return o.symbol?`${a} ${o.symbol}`:a},q=t=>{const n=t.policyType;let o=0;if(n.subscription){const a=n.subscription.paymentFrequency,u=Object.keys(a)[0];switch(u){case"daily":return u;case"weekly":return u;case"monthly":return u;case"quarterly":return u;case"semiAnnually":return u;case"annually":return u;case"custom":o=a.custom[0].toNumber();break;default:o=0}}if(o===0)return"N/A";const r=le({start:0,end:o*1e3});return ue(r,{format:["days","hours","minutes"]})},B=t=>{if(!t.policyType.subscription.nextPaymentDue)return"N/A";const n=new Date(t.policyType.subscription.nextPaymentDue.toNumber()*1e3);return n<new Date?"Overdue":de(n,{addSuffix:!0})},O=t=>{const n=t.status;return n.active?"Active":n.paused?"Paused":n.cancelled?"Cancelled":n.completed?"Completed":"Unknown"},J=t=>{const n=t.policyType;return n.subscription?"Subscription":n.oneTime?"One Time":n.installment?"Installment":"Unknown"},S=t=>{if(!t.memo||t.memo.length===0)return"no memo";const n=re(t.memo);return n.length?n:"no memo"},X=t=>t.policyType.subscription.nextPaymentDue?new Date(t.policyType.subscription.nextPaymentDue.toNumber()*1e3)<=new Date:!1,Y=(t,n)=>{navigator.clipboard.writeText(t),E(n),setTimeout(()=>E(null),2e3)},z=async(t,n,o)=>{if(!i||!c.publicKey)return d.error("Wallet not connected");try{const r=await i.getPaymentGateway(n.gateway);if(!r)return d.error("Gateway not found");if(r.authority.toString()!==c.publicKey.toString()&&o.owner.toString()!=c.publicKey.toString())return d.error("Only the gateway authority can execute payments");C(x=>new Set(x).add(t.toString()));const a=new j;(await i.executePayment(t)).map(x=>a.add(x));const p=await i.provider.sendAndConfirm(a);d.success(`Payment executed! TX: ${p}`),f(!1)}catch(r){console.error("Error:",r),d.error(r instanceof Error?r.message:"Failed to execute payment")}finally{C(r=>{const a=new Set(r);return a.delete(t.toString()),a})}},H=async(t,n,o)=>{if(!i||!c.publicKey)return d.error("Wallet not connected");if(o.owner.toString()!==c.publicKey.toString())return d.error("Only the policy owner can change status");try{A(h=>new Set(h).add(t.toString()));const a=n.status.active,u=a?{paused:{}}:{active:{}},p=new j,x=await i.changePaymentPolicyStatus(o.tokenMint,n.policyId,u);p.add(x),await i.provider.sendAndConfirm(p),d.success(`Payment policy ${a?"paused":"resumed"}!`),f(!1)}catch(r){console.error("Error:",r),d.error(r instanceof Error?r.message:"Failed to toggle status")}finally{A(r=>{const a=new Set(r);return a.delete(t.toString()),a})}},Z=async(t,n,o)=>{if(!i||!c.publicKey)return d.error("Wallet not connected");if(o.owner.toString()!==c.publicKey.toString())return d.error("Only the policy owner can delete");if(confirm("Delete this payment policy? This cannot be undone."))try{I(u=>new Set(u).add(t.toString()));const r=new j,a=await i.deletePaymentPolicy(o.tokenMint,n.policyId);r.add(a),await i.provider.sendAndConfirm(r),d.success("Payment policy deleted!"),f(!1)}catch(r){console.error("Error:",r),d.error(r instanceof Error?r.message:"Failed to delete")}finally{I(r=>{const a=new Set(r);return a.delete(t.toString()),a})}};if(!c.connected)return e.jsx("div",{className:"flex items-center justify-center min-h-[500px]",children:e.jsx("p",{className:"text-lg text-gray-600",children:"Please connect your wallet to view your account"})});if($)return e.jsxs("div",{className:"flex flex-col items-center justify-center min-h-[500px] gap-4",children:[e.jsx("div",{className:"w-16 h-16 border-4 border-[var(--color-primary)] border-t-transparent rounded-full animate-spin"}),e.jsx("p",{className:"text-sm uppercase tracking-wide",style:{fontFamily:"var(--font-secondary)",color:"var(--color-primary)"},children:"Loading..."})]});if(g.length<1)return e.jsx("div",{className:"flex items-center justify-center min-h-[500px]",children:e.jsx("p",{className:"text-lg text-gray-600",children:"You don't have any Subscriptions yet"})});const y=s?g.find(t=>t.policies.some(n=>n.publicKey.toString()===s.publicKey.toString())):null,l=({label:t,value:n,copyable:o})=>e.jsxs("div",{className:"flex items-center py-1 border-b border-gray-100 last:border-0",children:[e.jsx("span",{className:"min-w-[120px] md:min-w-[200px] text-sm text-gray-600 uppercase font-medium",children:t}),e.jsxs("div",{className:"flex items-center gap-3 flex-1",children:[e.jsx("span",{className:"text-sm break-all font-mono text-gray-700",children:n}),o&&e.jsx("button",{onClick:()=>Y(n,t),className:"p-1.5 hover:bg-gray-100 rounded transition-colors flex-shrink-0",title:"Copy to clipboard",children:G===t?e.jsx(te,{className:"h-4 w-4 text-green-600"}):e.jsx(ne,{className:"h-4 w-4 text-gray-500"})})]})]});return e.jsxs("div",{className:"flex flex-col md:flex-row",children:[e.jsx("div",{className:"w-full md:w-[368px] md:border-r md:border-gray-200",children:e.jsx("div",{className:"flex flex-col",children:g.map(({policies:t,userPayment:n})=>{const o=t.map(r=>{const a=s?.publicKey.toString()===r.publicKey.toString();return e.jsxs("div",{onClick:()=>k(r),className:`min-h-[3rem] flex items-center px-4 cursor-pointer transition-colors hover:bg-gray-200 ${a?"border-l-primary border-l-5":""}`,children:[e.jsx("div",{className:"w-8 h-8 flex items-center justify-center border border-[var(--color-primary)] rounded text-xs",style:{backgroundColor:a?"#fff":"transparent"},children:r.account.policyId}),e.jsxs("div",{className:"ml-3 flex flex-col gap-1 text-sm p-2",children:[e.jsx("span",{className:"uppercase",children:e.jsx(se,{publicKey:r.account.recipient})}),e.jsxs("span",{className:"text-xs text-gray-500",children:[S(r.account)," | ",r.account.paymentCount," payments"]})]})]},r.publicKey.toString())});return e.jsxs("div",{children:[e.jsx("div",{className:"h-12 flex items-center justify-between px-4 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"uppercase text-sm",children:T.get(n.tokenMint.toString())?.symbol??"unknown"}),e.jsxs("span",{className:"uppercase text-sm",children:["(",g.reduce((r,a)=>r+a.policies.length,0),")"]})]})}),e.jsx("div",{children:o})]})})})}),e.jsxs("div",{className:"flex-1 overflow-y-auto",children:[e.jsx("div",{className:"h-12 flex items-center px-4 md:px-6 border-b border-gray-200",children:e.jsx("span",{className:"uppercase text-sm",children:s?`Policy-${s.account.policyId} subscription`:"Select a policy"})}),s&&y&&e.jsxs("div",{className:"p-4 md:p-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("svg",{className:"w-4 h-4",viewBox:"0 0 18 18",fill:"none",stroke:"var(--color-primary)",strokeWidth:"2",children:e.jsx("circle",{cx:"9",cy:"9",r:"7"})}),e.jsx("span",{className:"underline font-medium",children:"Details"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>z(s.publicKey,s.account,y.userPayment),disabled:!X(s.account)||K.has(s.publicKey.toString()),className:"p-2 border border-blue-600 rounded hover:bg-blue-600 hover:text-white transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:K.has(s.publicKey.toString())?e.jsx("div",{className:"w-4 h-4 border-2 border-current border-t-transparent rounded-full animate-spin"}):e.jsx(ae,{className:"h-4 w-4"})}),e.jsx("button",{onClick:()=>H(s.publicKey,s.account,y.userPayment),disabled:D.has(s.publicKey.toString()),className:"p-2 border border-orange-600 rounded hover:bg-orange-600 hover:text-white transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:D.has(s.publicKey.toString())?e.jsx("div",{className:"w-4 h-4 border-2 border-current border-t-transparent rounded-full animate-spin"}):O(s.account)==="Active"?e.jsx(oe,{className:"h-4 w-4"}):e.jsx(ce,{className:"h-4 w-4"})}),e.jsx("button",{onClick:()=>Z(s.publicKey,s.account,y.userPayment),disabled:M.has(s.publicKey.toString()),className:"p-2 border border-red-600 rounded hover:bg-red-600 hover:text-white transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:M.has(s.publicKey.toString())?e.jsx("div",{className:"w-4 h-4 border-2 border-current border-t-transparent rounded-full animate-spin"}):e.jsx(ie,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"max-w-[700px]",children:[e.jsx(l,{label:"Policy Address",value:s.publicKey.toString(),copyable:!0}),e.jsx(l,{label:"Owner",value:y.userPayment.owner.toString(),copyable:!0}),e.jsx(l,{label:"Policy ID",value:`#${s.account.policyId}`}),e.jsx(l,{label:"Type",value:J(s.account)}),e.jsx(l,{label:"Status",value:O(s.account)}),e.jsx(l,{label:"Recipient",value:s.account.recipient.toString(),copyable:!0}),e.jsx(l,{label:"Gateway",value:s.account.gateway.toString(),copyable:!0}),e.jsx(l,{label:"Token Mint",value:y.userPayment.tokenMint.toString(),copyable:!0}),e.jsx(l,{label:"Amount",value:U(W(s.account),y.userPayment.tokenMint)}),e.jsx(l,{label:"Interval",value:q(s.account)}),e.jsx(l,{label:"Next Payment",value:B(s.account)}),e.jsx(l,{label:"Total Paid",value:U(s.account.totalPaid.toString(),y.userPayment.tokenMint)}),e.jsx(l,{label:"Payments",value:s.account.paymentCount.toString()}),e.jsx(l,{label:"Created",value:new Date(y.userPayment.createdAt.toNumber()*1e3).toLocaleString()}),S(s.account)&&e.jsx(l,{label:"Memo",value:S(s.account)})]})]})]})]})}export{he as default};

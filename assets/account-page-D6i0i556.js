import{j as e}from"./ui-vendor-CRek-TH2.js";import{g as Q,u as V,r as d}from"./wallet-adapter-BdusPX8w.js";import{h as _,T as j}from"./solana-vendor-Dw0U37Pl.js";import{u as ee,C as te,a as ne}from"./copy-DZkuWqx-.js";import{d as re}from"./utils-C_YcIsRq.js";import{t as u}from"./index-w-U20KRi.js";import{P as se,a as ae,b as oe,R as ce,T as ie,i as le,f as ue,c as de}from"./intervalToDuration-BAi1UB4t.js";import"./createLucideIcon-QEjNn_cq.js";function we(){const{connection:w}=Q(),c=V(),i=ee(c,w),[R,P]=d.useState(!0),[N,f]=d.useState(!1),[g,L]=d.useState([]),[s,T]=d.useState(null),[k,G]=d.useState(new Map),[C,K]=d.useState(new Set),[D,A]=d.useState(new Set),[M,I]=d.useState(new Set),[W,E]=d.useState(null);d.useEffect(()=>{c.publicKey?.toString()&&f(!1)},[c.publicKey]),d.useEffect(()=>{(async()=>{if(!(!i||N)&&c.publicKey)try{P(!0);const r=await i.getAllUserPaymentsByOwner(c.publicKey),a=new Map,t=new Map;for(const o of r){const x=await i.getPaymentPoliciesByUser(o.publicKey);for(const p of x){const y=p.account.userPayment.toString();if(!a.has(y)){const b=await i.getUserPayment(p.account.userPayment);if(b){if(b.owner.toString()!=c.publicKey.toString())continue;a.set(y,{userPaymentAddress:p.account.userPayment,userPayment:b,policies:[]});const $=b.tokenMint.toString();if(!t.has($))try{const v=await _(w,b.tokenMint);t.set($,{decimals:v.decimals,symbol:"TOKEN"})}catch(v){console.error("Error fetching mint info:",v)}}}const h=a.get(y);h&&h.policies.push(p)}}if(t.set("4zMMC9srt5Ri5X14GAgXhaHii3GnPAEERYPJgZJDncDU",{decimals:6,symbol:"USDC"}),L(Array.from(a.values())),G(t),Array.from(a.values()).length>0){const o=Array.from(a.values())[0].policies[0];T(o)}f(!0)}catch(r){console.error("Error fetching payment policies:",r)}finally{P(!1)}})()},[i,N,w,c.publicKey]);const F=n=>{const r=n.policyType;return r.subscription?Number(r.subscription.amount).toString():null},U=(n,r)=>{if(!n)return"N/A";const a=k.get(r.toString());if(!a)return n;const t=Number(n)/Math.pow(10,a.decimals);return a.symbol?`${t.toLocaleString()} ${a.symbol}`:t.toLocaleString()},B=n=>{const r=n.policyType;let a=0;if(r.subscription&&(a=Number(r.subscription.intervalSeconds)),a===0)return"N/A";const t=le({start:0,end:a*1e3});return ue(t,{format:["days","hours","minutes"]})},X=n=>{if(!n.policyType.subscription.nextPaymentDue)return"N/A";const r=new Date(n.policyType.subscription.nextPaymentDue.toNumber()*1e3);return r<new Date?"Overdue":de(r,{addSuffix:!0})},O=n=>{const r=n.status;return r.active?"Active":r.paused?"Paused":r.cancelled?"Cancelled":r.completed?"Completed":"Unknown"},J=n=>{const r=n.policyType;return r.subscription?"Subscription":r.oneTime?"One Time":r.installment?"Installment":"Unknown"},S=n=>{if(!n.memo||n.memo.length===0)return"no memo";const r=re(n.memo);return r.length?r:"no memo"},Y=n=>n.policyType.subscription.nextPaymentDue?new Date(n.policyType.subscription.nextPaymentDue.toNumber()*1e3)<=new Date:!1,z=(n,r)=>{navigator.clipboard.writeText(n),E(r),setTimeout(()=>E(null),2e3)},H=async(n,r,a)=>{if(!i||!c.publicKey)return u.error("Wallet not connected");try{const t=await i.getPaymentGateway(r.gateway);if(!t)return u.error("Gateway not found");if(t.authority.toString()!==c.publicKey.toString()&&a.owner.toString()!=c.publicKey.toString())return u.error("Only the gateway authority can execute payments");K(y=>new Set(y).add(n.toString()));const o=new j;(await i.executePayment(n)).map(y=>o.add(y));const p=await i.provider.sendAndConfirm(o);u.success(`Payment executed! TX: ${p}`),f(!1)}catch(t){console.error("Error:",t),u.error(t instanceof Error?t.message:"Failed to execute payment")}finally{K(t=>{const o=new Set(t);return o.delete(n.toString()),o})}},Z=async(n,r,a)=>{if(!i||!c.publicKey)return u.error("Wallet not connected");if(a.owner.toString()!==c.publicKey.toString())return u.error("Only the policy owner can change status");try{A(h=>new Set(h).add(n.toString()));const o=r.status.active,x=o?{paused:{}}:{active:{}},p=new j,y=await i.changePaymentPolicyStatus(a.tokenMint,r.policyId,x);p.add(y),await i.provider.sendAndConfirm(p),u.success(`Payment policy ${o?"paused":"resumed"}!`),f(!1)}catch(t){console.error("Error:",t),u.error(t instanceof Error?t.message:"Failed to toggle status")}finally{A(t=>{const o=new Set(t);return o.delete(n.toString()),o})}},q=async(n,r,a)=>{if(!i||!c.publicKey)return u.error("Wallet not connected");if(a.owner.toString()!==c.publicKey.toString())return u.error("Only the policy owner can delete");if(confirm("Delete this payment policy? This cannot be undone."))try{I(x=>new Set(x).add(n.toString()));const t=new j,o=await i.deletePaymentPolicy(a.tokenMint,r.policyId);t.add(o),await i.provider.sendAndConfirm(t),u.success("Payment policy deleted!"),f(!1)}catch(t){console.error("Error:",t),u.error(t instanceof Error?t.message:"Failed to delete")}finally{I(t=>{const o=new Set(t);return o.delete(n.toString()),o})}};if(!c.connected)return e.jsx("div",{className:"flex items-center justify-center min-h-[500px]",children:e.jsx("p",{className:"text-lg text-gray-600",children:"Please connect your wallet to view your account"})});if(R)return e.jsxs("div",{className:"flex flex-col items-center justify-center min-h-[500px] gap-4",children:[e.jsx("div",{className:"w-16 h-16 border-4 border-[var(--color-primary)] border-t-transparent rounded-full animate-spin"}),e.jsx("p",{className:"text-sm uppercase tracking-wide",style:{fontFamily:"var(--font-secondary)",color:"var(--color-primary)"},children:"Loading..."})]});if(g.length<1)return e.jsx("div",{className:"flex items-center justify-center min-h-[500px]",children:e.jsx("p",{className:"text-lg text-gray-600",children:"You don't have any Subscriptions yet"})});const m=s?g.find(n=>n.policies.some(r=>r.publicKey.toString()===s.publicKey.toString())):null,l=({label:n,value:r,copyable:a})=>e.jsxs("div",{className:"flex items-center py-1 border-b border-gray-100 last:border-0",children:[e.jsx("span",{className:"min-w-[120px] md:min-w-[200px] text-sm text-gray-600 uppercase font-medium",children:n}),e.jsxs("div",{className:"flex items-center gap-3 flex-1",children:[e.jsx("span",{className:"text-sm break-all font-mono text-gray-700",children:r}),a&&e.jsx("button",{onClick:()=>z(r,n),className:"p-1.5 hover:bg-gray-100 rounded transition-colors flex-shrink-0",title:"Copy to clipboard",children:W===n?e.jsx(te,{className:"h-4 w-4 text-green-600"}):e.jsx(ne,{className:"h-4 w-4 text-gray-500"})})]})]});return e.jsxs("div",{className:"flex flex-col md:flex-row",children:[e.jsx("div",{className:"w-full md:w-[368px] md:border-r md:border-gray-200",children:e.jsx("div",{className:"flex flex-col",children:g.map(({policies:n,userPayment:r})=>{const a=n.map(t=>{const o=s?.publicKey.toString()===t.publicKey.toString();return e.jsxs("div",{onClick:()=>T(t),className:`min-h-[3rem] flex items-center px-4 cursor-pointer transition-colors hover:bg-gray-200 ${o?"border-l-primary border-l-5":""}`,children:[e.jsx("div",{className:"w-8 h-8 flex items-center justify-center border border-[var(--color-primary)] rounded text-xs",style:{backgroundColor:o?"#fff":"transparent"},children:t.account.policyId}),e.jsxs("div",{className:"ml-3 flex flex-col gap-1 text-sm p-2",children:[e.jsx("span",{className:"uppercase",children:e.jsx(se,{publicKey:t.account.recipient})}),e.jsxs("span",{className:"text-xs text-gray-500",children:[S(t.account)," | ",t.account.paymentCount," payments"]})]})]},t.publicKey.toString())});return e.jsxs("div",{children:[e.jsx("div",{className:"h-12 flex items-center justify-between px-4 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"uppercase text-sm",children:k.get(r.tokenMint.toString())?.symbol??"unknown"}),e.jsxs("span",{className:"uppercase text-sm",children:["(",g.reduce((t,o)=>t+o.policies.length,0),")"]})]})}),e.jsx("div",{children:a})]})})})}),e.jsxs("div",{className:"flex-1 overflow-y-auto",children:[e.jsx("div",{className:"h-12 flex items-center px-4 md:px-6 border-b border-gray-200",children:e.jsx("span",{className:"uppercase text-sm",children:s?`Policy-${s.account.policyId} subscription`:"Select a policy"})}),s&&m&&e.jsxs("div",{className:"p-4 md:p-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("svg",{className:"w-4 h-4",viewBox:"0 0 18 18",fill:"none",stroke:"var(--color-primary)",strokeWidth:"2",children:e.jsx("circle",{cx:"9",cy:"9",r:"7"})}),e.jsx("span",{className:"underline font-medium",children:"Details"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>H(s.publicKey,s.account,m.userPayment),disabled:!Y(s.account)||C.has(s.publicKey.toString()),className:"p-2 border border-blue-600 rounded hover:bg-blue-600 hover:text-white transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:C.has(s.publicKey.toString())?e.jsx("div",{className:"w-4 h-4 border-2 border-current border-t-transparent rounded-full animate-spin"}):e.jsx(ae,{className:"h-4 w-4"})}),e.jsx("button",{onClick:()=>Z(s.publicKey,s.account,m.userPayment),disabled:D.has(s.publicKey.toString()),className:"p-2 border border-orange-600 rounded hover:bg-orange-600 hover:text-white transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:D.has(s.publicKey.toString())?e.jsx("div",{className:"w-4 h-4 border-2 border-current border-t-transparent rounded-full animate-spin"}):O(s.account)==="Active"?e.jsx(oe,{className:"h-4 w-4"}):e.jsx(ce,{className:"h-4 w-4"})}),e.jsx("button",{onClick:()=>q(s.publicKey,s.account,m.userPayment),disabled:M.has(s.publicKey.toString()),className:"p-2 border border-red-600 rounded hover:bg-red-600 hover:text-white transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:M.has(s.publicKey.toString())?e.jsx("div",{className:"w-4 h-4 border-2 border-current border-t-transparent rounded-full animate-spin"}):e.jsx(ie,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"max-w-[700px]",children:[e.jsx(l,{label:"Policy Address",value:s.publicKey.toString(),copyable:!0}),e.jsx(l,{label:"Owner",value:m.userPayment.owner.toString(),copyable:!0}),e.jsx(l,{label:"Policy ID",value:`#${s.account.policyId}`}),e.jsx(l,{label:"Type",value:J(s.account)}),e.jsx(l,{label:"Status",value:O(s.account)}),e.jsx(l,{label:"Recipient",value:s.account.recipient.toString(),copyable:!0}),e.jsx(l,{label:"Gateway",value:s.account.gateway.toString(),copyable:!0}),e.jsx(l,{label:"Token Mint",value:m.userPayment.tokenMint.toString(),copyable:!0}),e.jsx(l,{label:"Amount",value:U(F(s.account),m.userPayment.tokenMint)}),e.jsx(l,{label:"Interval",value:B(s.account)}),e.jsx(l,{label:"Next Payment",value:X(s.account)}),e.jsx(l,{label:"Total Paid",value:U(s.account.totalPaid.toString(),m.userPayment.tokenMint)}),e.jsx(l,{label:"Payments",value:s.account.paymentCount.toString()}),e.jsx(l,{label:"Created",value:new Date(m.userPayment.createdAt.toNumber()*1e3).toLocaleString()}),S(s.account)&&e.jsx(l,{label:"Memo",value:S(s.account)})]})]})]})]})}export{we as default};
